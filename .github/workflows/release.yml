name: Release Binaries

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build cross-platform artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          VERSION="${GITHUB_REF_NAME:-dev}"
          BIN_NAME="memory-cli"

          targets=(
            "darwin amd64"
            "darwin arm64"
            "windows amd64"
            "windows arm64"
          )

          for target in "${targets[@]}"; do
            read -r goos goarch <<<"${target}"
            out="${BIN_NAME}_${VERSION}_${goos}_${goarch}"
            ext=""
            if [[ "${goos}" == "windows" ]]; then
              ext=".exe"
            fi

            GOOS="${goos}" GOARCH="${goarch}" CGO_ENABLED=0 \
              go build -trimpath -ldflags="-s -w" \
              -o "dist/${out}${ext}" ./cmd/memory-cli

            (
              cd dist
              zip -q "${out}.zip" "${out}${ext}"
              rm -f "${out}${ext}"
            )
          done

          (
            cd dist
            shasum -a 256 ./*.zip > SHA256SUMS
          )

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: memory-cli-release-artifacts
          path: dist/*

      - name: Publish GitHub release assets
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.zip
            dist/SHA256SUMS
